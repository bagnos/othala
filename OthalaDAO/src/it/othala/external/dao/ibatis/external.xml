<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="it.othala.external.queries">

	<select id="getQtStock" resultType="Integer" parameterType="java.lang.String">

		SELECT COALESCE(MAX(QtaGiacUmMag),0) QTA 
		FROM Y_ARTICOLI_VARIANTI 
		WHERE CodBarre = #{barcode}

	</select>
	
	<resultMap id="ScontoFidelity" type="it.othala.dto.FidelityCardDTO">
		<id property="idFidelity" column="Cliente" javaType="java.lang.String" />
		<result property="pcSconto" column="CodCategoriaSconti" javaType="java.lang.Integer" />
	</resultMap>
	
	<select id="getScontoFidelity" resultMap="ScontoFidelity" parameterType="java.lang.Integer">
		
		SELECT Cliente, CodCategoriaSconti 
		FROM Y_FIDELITY_CARDS_ESHOP 
		WHERE Cliente = #{idFidelity}
		
	</select>
	
	<select id="getShopStock" resultType="it.othala.external.dto.ShopDegortesDTO" parameterType="java.lang.String">
		
		SELECT b.codMagaz, b.DesNegozio 
		FROM Y_ARTICOLI_VARIANTI a, Y_NEGOZI_ESHOP b
		WHERE a.CodBarre = #{barCode}
		AND a.QtaGiacUmMag = (SELECT MAX(c.QtaGiacUmMag)  
								FROM Y_ARTICOLI_VARIANTI c
								WHERE c.CodBarre = #{barCode})
		AND a.QtaGiacUmMag > 0
		AND a.codmag = b.codMagaz

	</select>


</mapper>