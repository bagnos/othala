<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="it.othala.product.queries">

	<select id="listMenu" resultType="it.othala.dto.MenuDTO"
		parameterType="java.util.HashMap">


		SELECT
		a.idGender,
		a.txGender,
		b.txLibrary as imgLibrary,
		b.txName as imgName
		FROM
		${database.schema}gender a,
		${database.schema}site_images b
		where a.idLanguages = #{languages}
		and
		b.txGroupImages = 'tabNav'
		and b.pgGroupImages = a.idGender;


	</select>

	<select id="listSubMenu" resultType="it.othala.dto.SubMenuDTO"
		parameterType="java.util.HashMap">


		SELECT idType, txType
		FROM
		${database.schema}type d
		where
		d.idLanguages = #{languages}
		and exists
		(select 1 from
		${database.schema}product a
		where
		a.idProductState = 1
		and
		a.idType =
		d.idType
		and a.idGender = #{idMenu}
		)


	</select>


	<select id="listProduct" resultType="it.othala.dto.ProductDTO"
		parameterType="java.util.HashMap">

		SELECT
		a.idProduct ,
		imPrice as price,
		txBrand as brand,
		txThumbnailsUrl
		as imagesUrl,
		ceiling(imPrice * (100 - pcDiscount) / 100) as
		priceDiscounted,
		txDescription as description,
		txGender as gender,
		txType as type,
		pcDiscount as discount,
		case
		when a.dtProductState
		>
		current_date - 7 then 'Y'
		else 'N'
		end as fgNewArrivals
		FROM

		${database.schema}product a,
		${database.schema}product_description b,
		${database.schema}brand c,
		${database.schema}gender f,
		`type` g
		where
		a.idProduct = b.idProduct
		and b.idLanguages = #{languages}
		and
		a.idProductState = 1
		and c.idBrand = a.idBrand
		and f.idGender =
		a.idGender
		and g.idType = a.idType
		and exists
		(select 1 from
		${database.schema}article
		d where
		d.idProduct =
		a.idProduct
		and
		d.qtStock >
		0)

		<if test="minPrice != null">
			and (imPrice * (100 - pcDiscount) / 100) &gt;= #{minPrice}
		</if>

		<if test="maxPrice != null">
			and (imPrice * (100 - pcDiscount) / 100) &lt;= #{maxPrice}
		</if>
		<if test="newArrivals != null and newArrivals == true">
			and a.dtProductState > current_date - 7
		</if>

		<if test="type != null">
			and a.idType = #{type}
		</if>

		<if test="gender != null">
			and a.idGender = #{gender}
		</if>

		<if test="brand != null">
			and a.idBrand = #{brand}
		</if>

		<if test="size != null">
			and exists (select 1 from
			${database.schema}article d
			where
			a.idProduct =
			d.idProduct
			and
			d.idSize = #{size}
			and
			d.qtStock > 0
			)
		</if>

		<if test="color != null">
			and exists (select 1 from
			${database.schema}article d
			where
			a.idProduct =
			d.idProduct
			and
			d.idColor = #{color}
			and
			d.qtStock > 0
			)
		</if>
		<if test="order != null">
			<if test="order == 1">
				order by priceDiscounted asc
			</if>
			<if test="order == 2">
				order by priceDiscounted desc
			</if>
		</if>


	</select>

	<select id="listDistinctArticleSize" resultType="String"
		parameterType="java.util.HashMap">


		SELECT distinct(txSize) FROM ${database.schema}article
		a,
		${database.schema}size b
		where a.idSize = b.idSize
		and a.idProduct =
		#{idProduct}
		and a.qtStock > 0

	</select>


	<select id="listDistinctArticleColor" resultType="String"
		parameterType="java.util.HashMap">


		SELECT distinct(txColor) FROM ${database.schema}article
		a,
		${database.schema}color b
		where a.idColor = b.idColor
		and a.idProduct
		= #{idProduct}
		and a.qtStock > 0
		and b.idLanguages = #{languages}

	</select>


	<select id="listSize" resultType="it.othala.dto.AttributeSizeDTO">

		SELECT c.idType, idSize as
		attributo,txSize as valore
		FROM
		${database.schema}size a,
		${database.schema}type_size b,
		${database.schema}size_type_size c
		where
		a.idTypeSize = b.idTypeSize
		and a.idTypeSize = c.idTypeSize
		order by 1

	</select>

	<select id="listColor" resultType="it.othala.dto.AttributeDTO"
		parameterType="java.util.HashMap">

		SELECT idColor as attributo,txColor as valore
		FROM
		${database.schema}color d
		where
		idLanguages = #{languages}
		order by 2

	</select>

	<select id="listBrand" resultType="it.othala.dto.AttributeDTO"
		parameterType="java.util.HashMap">

		SELECT idBrand as attributo,txBrand as valore
		FROM
		${database.schema}brand d
		where
		idLanguages = #{languages}
		order by 2

	</select>

	<select id="listGender" resultType="it.othala.dto.AttributeDTO"
		parameterType="java.util.HashMap">

		SELECT idGender as attributo,txGender as valore
		FROM
		${database.schema}gender d
		where
		idLanguages = #{languages}
		order by 2

	</select>

	<select id="listType" resultType="it.othala.dto.AttributeDTO"
		parameterType="java.util.HashMap">

		SELECT idType as attributo,txType as valore
		FROM
		${database.schema}type d
		where
		idLanguages = #{languages}
		order by 2

	</select>


	<select id="listProductImages" resultType="String"
		parameterType="java.util.HashMap">

		SELECT txImageUrl FROM ${database.schema}product_image
		where
		idProduct = #{idProduct}

	</select>



	<select id="getProductFull" resultType="it.othala.dto.ProductFullDTO"
		parameterType="java.util.HashMap">


		SELECT
		a.idProduct as idProduct,
		a.imPrice as price,
		a.txThumbnailsUrl as thumbnailsUrl,
		a.pcDiscount as discount,
		ceiling(a.imPrice * (100 - a.pcDiscount) /
		100) as priceDiscounted,
		b.txDescription as description,
		case when
		a.dtProductState >
		current_date - 7 then 'S' else 'N' end as
		fgNewArrivals,
		a.idGender,
		txGender,
		a.idType,
		txType,
		a.idBrand,
		txBrand

		FROM
		${database.schema}product a,
		${database.schema}product_description b,

		${database.schema}gender c,
		${database.schema}type d,
		${database.schema}brand e

		where
		a.idProduct = #{idProduct}
		and
		a.idProduct = b.idProduct
		and
		b.idLanguages = #{languages}
		and a.idType =
		d.idType
		and a.idGender = c.idGender
		and a.idBrand = e.idBrand
		and
		d.idLanguages = b.idLanguages
		and c.idLanguages = b.idLanguages
		and
		e.idLanguages = b.idLanguages


	</select>




	<select id="listArticleFull" resultType="it.othala.dto.ArticleFullDTO"
		parameterType="java.util.HashMap">


		SELECT
		a.pgArticle as pgArticle,
		a.qtStock as qtStock,

		a.idSize,

		txSize,

		a.idColor,

		txColor,
		coalesce(a.txThumbnailsUrl,
		d.txThumbnailsUrl) as thumbnailsUrl



		FROM
		${database.schema}article a,
		${database.schema}size b,
		${database.schema}color c,
		${database.schema}product d


		where
		a.idProduct
		=
		#{idProduct}
		and a.idSize =
		b.idSize
		and c.idColor = a.idColor
		and
		c.idLanguages = #{languages}
		and
		d.idProduct = a.idProduct


	</select>


	<select id="getArticleFull" resultType="it.othala.dto.ArticleFullDTO"
		parameterType="java.util.HashMap">


		SELECT
		a.pgArticle as pgArticle,
		a.qtStock as qtStock,

		a.idSize,

		txSize,

		a.idColor,

		txColor,
		coalesce(a.txThumbnailsUrl,
		d.txThumbnailsUrl) as thumbnailsUrl



		FROM
		${database.schema}article a,
		${database.schema}size b,
		${database.schema}color c,
		${database.schema}product d


		where
		a.idProduct
		=
		#{idProduct}
		and a.pgArticle
		=
		#{pgArticle}
		and a.idSize =
		b.idSize
		and c.idColor = a.idColor
		and
		c.idLanguages = #{languages}
		and
		d.idProduct = a.idProduct


	</select>
	
	
	<select id="getShop" resultType="it.othala.dto.ShopDTO"
		parameterType="java.util.HashMap">


		SELECT
		a.idShop,
		a.txShop,
		a.txMail

		FROM
		${database.schema}shops a,
		${database.schema}article b



		Where b.idProduct = #{idProduct}
		and b.pgArticle = #{pgArticle}
		and a.idShop
		=
		b.idShop

	</select>

	<insert id="insertProduct" parameterType="it.othala.dto.ProductFullDTO">



		INSERT INTO
		${database.schema}product
		(`idGender`,
		`idType`,
		`idBrand`,
		`imPrice`,
		`pcDiscount`,
		`txThumbnailsUrl`,
		`idProductState`,
		`dtProductState`)

		values (#{idGender},#{idType},#{idBrand},
		#{price},#{discount},#{thumbnailsUrl},0,now())

		<selectKey resultType="java.lang.Integer" keyProperty="idProduct">

			SELECT LAST_INSERT_ID() AS idProduct

		</selectKey>




	</insert>


	<insert id="insertProductDescription" parameterType="java.util.HashMap">

		INSERT INTO
		${database.schema}product_description
		(`idProduct`,`idLanguages`,`txDescription`)
		values (#{idProduct},
		#{idLanguages},#{txDescription})

	</insert>


	<insert id="insertArticle" parameterType="java.util.HashMap">

		INSERT INTO
		${database.schema}article
		(`idProduct`,
		`pgArticle`,
		`idSize`,
		`idColor`,
		`qtStock`,
		`txThumbnailsUrl`,
		`idShop`)
		VALUES
		(#{idProduct},
		#{pgArticle},#{idSize},#{idColor},#{qtStock},#{thumbnailsUrl},#{idShop});


	</insert>


	<insert id="insertProductImage" parameterType="java.util.HashMap">

		INSERT INTO
		${database.schema}product_image
		(`idProduct`,
		`pgImage`,
		`txImageUrl`)
		VALUES
		(#{idProduct}, #{pgImage},#{txImageUrl});

	</insert>

	<select id="getQtStock" resultType="Integer" parameterType="java.util.HashMap">

		SELECT qtStock
		FROM ${database.schema}article
		Where idProduct =
		#{idProduct}
		and pgArticle = #{pgArticle};


	</select>


</mapper>