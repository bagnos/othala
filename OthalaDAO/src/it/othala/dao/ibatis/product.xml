<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="it.othala.product.queries">



	<select id="listProduct" resultType="it.othala.dto.ProductDTO"
		parameterType="java.util.HashMap">

		SELECT
		a.idProduct ,
		imPrice as price,
		txDescription as description,
		pcDiscount
		as discount,
		ceiling(imPrice * (100 - pcDiscount) / 100) as
		priceDiscounted,
		case
		when a.dtProductState > current_date - 7 then 'S'
		else 'N'
		end as fgNewArrivals
		FROM
		${database.schema}product a,
		${database.schema}product_description b
		where a.idProduct = b.idProduct
		and b.idLanguages = #{languages}
		and a.idProductState = 1
		and exists (select 1 from
		${database.schema}article d where
		d.idProduct = a.idProduct
		and
		d.qtStock > 0)
		<if test="minPrice != null">
			and (imPrice * (100 - pcDiscount) / 100) &gt;= #{minPrice}
		</if>

		<if test="type != null">
			and (imPrice * (100 - pcDiscount) / 100) &lt;= #{maxPrice}
		</if>
		<if test="newArrivals != null and newArrivals == true">
			and a.dtProductState > current_date - 7
		</if>

		<if test="type != null">
			and exists (select 1 from
			${database.schema}product_attribute c where
			c.idProduct =
			a.idProduct
			and c.idProductAttribute = 1
			and
			c.pgProductAttribute = #{type})
		</if>

		<if test="gender != null">
			and exists (select 1 from
			${database.schema}product_attribute c where
			c.idProduct =
			a.idProduct
			and c.idProductAttribute = 2
			and
			c.pgProductAttribute = #{gender})
		</if>

		<if test="brand != null">
			and exists (select 1 from
			${database.schema}product_attribute c where
			c.idProduct =
			a.idProduct
			and c.idProductAttribute = 5
			and
			c.pgProductAttribute = #{brand})
		</if>

		<if test="size != null">
			and exists (select 1 from
			${database.schema}article_attribute c,
			${database.schema}article d
			where
			c.idProduct =
			a.idProduct
			and c.idProductAttribute = 4
			and
			c.pgProductAttribute = #{size}
			and d.idProduct = a.idProduct
			and
			d.qtStock > 0
			)
		</if>

		<if test="color != null">
			and exists (select 1 from
			${database.schema}article_attribute c,
			${database.schema}article d
			where
			c.idProduct =
			a.idProduct
			and c.idProductAttribute = 3
			and
			c.pgProductAttribute = #{color}
			and d.idProduct = a.idProduct
			and
			d.qtStock > 0
			)
		</if>






	</select>

	<select id="listArticleAttribute" resultType="String"
		parameterType="java.util.HashMap">

		SELECT txValore FROM ${database.schema}article_attribute
		a,
		${database.schema}valori_attributo c,
		${database.schema}valori_attributo_languages d,
		${database.schema}article e
		where
		a.idProductAttribute =
		c.idProductAttribute
		and a.pgProductAttribute =
		c.pgProductAttribute
		and a.idProductAttribute = d.idProductAttribute
		and
		a.pgProductAttribute = d.pgProductAttribute
		and a.idProduct =
		#{idProduct}
		and a.idProductAttribute = #{idProductAttribute}
		and
		d.idLanguages = #{languages}
		and e.idProduct = a.idProduct
		and
			e.qtStock > 0

	</select>

	<select id="listDistinctArticleAttribute" resultType="String"
		parameterType="java.util.HashMap">

		SELECT distinct(txValore) FROM
		${database.schema}article_attribute
		a,
		${database.schema}valori_attributo c,
		${database.schema}valori_attributo_languages d,
		${database.schema}article e
		where
		a.idProductAttribute =
		c.idProductAttribute
		and a.pgProductAttribute =
		c.pgProductAttribute
		and a.idProductAttribute = d.idProductAttribute
		and
		a.pgProductAttribute = d.pgProductAttribute
		and a.idProduct =
		#{idProduct}
		and a.idProductAttribute = #{idProductAttribute}
		and
		d.idLanguages = #{languages}
				and e.idProduct = a.idProduct
		and
			e.qtStock > 0

	</select>

	<select id="getProductAttribute" resultType="String"
		parameterType="java.util.HashMap">

		SELECT txValore FROM ${database.schema}product_attribute
		a,
		${database.schema}product b,
		${database.schema}attribute e,
		${database.schema}valori_attributo c,
		${database.schema}valori_attributo_languages d
		where a.idProduct =
		b.idProduct
		and a.idProductAttribute = c.idProductAttribute
		and
		a.pgProductAttribute = c.pgProductAttribute
		and a.idProductAttribute =
		d.idProductAttribute
		and a.pgProductAttribute = d.pgProductAttribute
		and a.idProduct = #{idProduct}
		and d.idLanguages = #{languages}
		and
		a.idProductAttribute = #{idProductAttribute}
		and e.idLanguages =
		d.idLanguages
		and e.idProductAttribute = a.idProductAttribute

	</select>

	<select id="listProductAttribute" resultType="it.othala.dto.AttributeDTO"
		parameterType="java.util.HashMap">

		SELECT a.idProductAttribute as attributo,txValore as
		valore
		FROM ${database.schema}product_attribute a,
		${database.schema}attribute e,
		${database.schema}valori_attributo c,
		${database.schema}valori_attributo_languages d
		where
		a.idProductAttribute = c.idProductAttribute
		and
		a.pgProductAttribute =
		c.pgProductAttribute
		and a.idProductAttribute =
		d.idProductAttribute
		and
		a.pgProductAttribute = d.pgProductAttribute
		and a.idProduct =
		#{idProduct}
		and d.idLanguages = #{languages}
		and
		e.idLanguages =
		d.idLanguages
		and e.idProductAttribute =
		a.idProductAttribute

	</select>

	<select id="listProductImages" resultType="String"
		parameterType="java.util.HashMap">

		SELECT txImageUrl FROM ${database.schema}product_image
		where
		idProduct = #{idProduct}

	</select>

	<select id="listDomain" resultType="it.othala.dto.AttributeDTO"
		parameterType="java.util.HashMap">

		SELECT d.pgProductAttribute as attributo,txValore as
		valore
		FROM
		${database.schema}valori_attributo_languages d
		where
		d.idLanguages = #{languages}
		and d.idProductAttribute =
		#{idProductAttribute}

	</select>

	<select id="listMenu" resultType="it.othala.dto.MenuDTO"
		parameterType="java.util.HashMap">

		SELECT d.pgProductAttribute as idGender,txValore as
		txGender
		FROM
		${database.schema}valori_attributo_languages d
		where
		d.idLanguages = #{languages}
		and d.idProductAttribute = 1

	</select>

	<select id="listSubMenu" resultType="it.othala.dto.SubMenuDTO"
		parameterType="java.util.HashMap">

		SELECT d.pgProductAttribute as idType,txValore as
		txType
		FROM
		${database.schema}valori_attributo_languages d
		where
		d.idLanguages = #{languages}
		and d.idProductAttribute = 2
		and exists (select 1 from product a,
        product_attribute b,
        product_attribute c
                where a.idProductState = 1
        and a.idProduct = b.idProduct
        and b.idProductAttribute = 1
        and b.pgProductAttribute = #{idMenu}        
        and a.idProduct = c.idProduct
        and c.idProductAttribute = d.idProductAttribute
        and c.pgProductAttribute = d.pgProductattribute)

        

	</select>


</mapper>