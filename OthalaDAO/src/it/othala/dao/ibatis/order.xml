<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="it.othala.order.queries">

	<resultMap id="Order" type="it.othala.dto.OrderFullDTO">
		<id property="idOrder" column="idOrder" />
		<result property="idUser" column="idUser" />
		<result property="imOrdine" column="imOrdine" />
		<result property="imSpeseSpedizione" column="imSpeseSpedizione" />
		<result property="idStato" column="idStato" />
		<result property="dtStato" column="dtStato" />
		<result property="txNote" column="txNote" />
		<result property="txStato" column="txStato" />
		<collection property="prodotti" ofType="it.othala.dto.OrderProductDTO">
			<result property="idProdotto" column="idProdotto" />
			<result property="pgArticle" column="pgArticle" />
			<result property="qtArticle" column="qtArticle" />
		</collection>
	</resultMap>
	
	
	<select id="listOrder" resultMap="Order" parameterType="java.util.HashMap">

		SELECT
		a.idOrder, a.idUser, a.imOrdine, a.imSpeseSpedizione,
		b.idProdotto, b.pgArticle, b.qtArticle,
		c.idStato c.dtStato, c.txNote, 
		d.txStato
		FROM
		${database.schema}orders a,
		${database.schema}orders_articles b,
		${database.schema}states_orders c,
		${database.schema}states d
		WHERE a.idOrder = b.idOrder
		and a.idOrder = c.idOrder
		and c.idStato = d.idStato
		<if test="idOrder != null">
			and a.idOrder = #{idOrder}
		</if>
		<if test="idUser != null">
			and a.idUser = #{idUser}
		</if>
		<if test="idStato != null">
			and c.idStato = #{idStato}
		</if>
		<if test="dtDatada != null">
			and c.dtStato &gt;= #{dtDatada}
		</if>
		<if test="dtDataA != null">
			and c.dtStato &lt;= #{dtDataA}
		</if>

	</select>


	<insert id="insertOrder"   parameterType="it.othala.dto.OrderFullDTO">
      
		INSERT INTO
		${database.schema}orders
		(`idUser`,`imOrdine`,`imSpeseSpedizione`)
		values (
		#{idUser},#{imOrdine},#{imSpeseSpedizione})
		
        <selectKey resultType="java.lang.Integer" keyProperty="idOrder" >

            SELECT LAST_INSERT_ID() AS idOrder

        </selectKey>
    </insert>


	<insert id="insertOrdersArticles" parameterType="it.othala.dto.OrderProductDTO">

		INSERT INTO
		${database.schema}orders_articles
		(`idOrder`,`idProdotto`,`pgArticle`,`qtArticle`)
		values (#{idOrder},#{idProdotto},#{pgArticle},#{qtArticle})

	</insert>

	<insert id="insertStatesOrders" parameterType="it.othala.dto.OrderFullDTO">
		INSERT INTO
		${database.schema}states_orders
		(`idOrder`,`idStato`,`dtStato`,`txNote`)
		VALUES
		(#{idOrder},1,now(),#{txNote});

	</insert>
	
	<insert id="updateStatesOrders" parameterType="it.othala.dto.StateOrderDTO">
		INSERT INTO
		${database.schema}states_orders
		(`idOrder`,`idStato`,`dtStato`,`txNote`)
		VALUES
		(#{idOrder},#{idStato},now(),#{txNote});

	</insert>
	
	<select id="deliveryAddresses" resultType="it.othala.dto.DeliveryAddressDTO"
		parameterType="java.lang.String">
		
		SELECT
		a.idTypeAddress as typeAddress, a.txNome as nome,a.txCognome as cognome,
		a.txVia as via, a.txComune as comune, a.cdCap as cap, 
		a.txProvincia as provincia, a.txNazione as nazione, 
		b.Descrizione as typeAddressDes, a.txTel as tel, c.idUser as userId
		FROM
		${database.schema}addresses a,
		${database.schema}type_address b,
		${database.schema}customer c
		WHERE
		a.idUser = #{userId} and
		a.idTypeAddress = b.idTypeAddress and
		a.idUser=c.idUser
	
	</select>
	
	<select id="deliveryCosts" resultType="it.othala.dto.DeliveryCostDTO">

		SELECT
		txDescrizione as descrizione,
		imSpese as importospese
		FROM 
		${database.schema}delivery_cost

	</select>
	
	<insert id="insertAddress" parameterType="it.othala.dto.DeliveryAddressDTO">
		INSERT INTO
		${database.schema}addresses
		(`idUser`,`idTypeAddress`,`txNome`,`txCognome`,`txVia`,
		`txComune`, `cdCap`, 
		`txProvincia`,`txNazione`)
		VALUES
		(#{userId},#{typeAddress},#{nome},#{cognome},#{via},
		#{comune},#{cap},#{provincia},#{nazione});

	</insert>
	
	<insert id="insertDeliveryCost" parameterType="it.othala.dto.DeliveryCostDTO">
		INSERT INTO
		${database.schema}delivery_cost
		(`txDescrizione`,`imSpese`)
		VALUES
		(#{descrizione},#{importospese});

	</insert>

</mapper>