<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="it.othala.order.queries">

	<resultMap id="Order" type="it.othala.dto.OrderFullDTO">
		<id property="idOrder" column="idOrder" />
		<result property="idUser" column="idUser" />
		<result property="imOrdine" column="imOrdine" />
		<result property="imSpeseSpedizione" column="imSpeseSpedizione" />
		<result property="idStato" column="idStato" />
		<result property="dtStato" column="dtStato" />
		<result property="txNote" column="txNote" />
		<result property="txStato" column="txStato" />
		<collection property="billingAddress" ofType="it.othala.dto.DeliveryAddressDTO">
			<result property="idAddress" column="idAddressBilling" />
			<result property="userId" column="idUser" />
			<result property="nome" column="txNomeBilling" />
			<result property="cognome" column="txCognomeBilling" />
			<result property="via" column="txViaBilling" />
			<result property="comune" column="txComuneBilling" />
			<result property="cap" column="cdCapBilling" />
			<result property="provincia" column="txProvinciaBilling" />
			<result property="nazione" column="txNazioneBilling" />
			<result property="tel" column="txTelBilling" />
			<result property="etichetta" column="etichettaBilling" />
		</collection>
		<collection property="shippingAddress" ofType="it.othala.dto.DeliveryAddressDTO">
			<result property="idAddress" column="idAddressDelivery" />
			<result property="userId" column="idUser" />
			<result property="nome" column="txNomeDelivery" />
			<result property="cognome" column="txCognomeDelivery" />
			<result property="via" column="txViaDelivery" />
			<result property="comune" column="txComuneDelivery" />
			<result property="cap" column="cdCapDelivery" />
			<result property="provincia" column="txProvinciaDelivery" />
			<result property="nazione" column="txNazioneDelivery" />
			<result property="tel" column="txTelDelivery" />
			<result property="etichetta" column="etichettaDelivery" />
		</collection>
		<collection property="cart" ofType="it.othala.dto.ArticleFullDTO">
			<result property="prdFullDTO.idProduct" column="idProdotto" />
			<result property="pgArticle" column="pgArticle" />
			<result property="qtBooked" column="qtArticle" />
		</collection>
	</resultMap>
	
	
	<select id="listOrder" resultMap="Order" parameterType="java.util.HashMap">

		SELECT
		a.idOrder, a.idUser, a.imOrdine, a.imSpeseSpedizione,
		a.idTransaction, a.idAddressFat, a.idAddressSpe,
		b.idProdotto, b.pgArticle, b.qtArticle,
		c.idStato, c.dtStato, c.txNote, 
		d.txStato, f.IDAddress as idAddressBilling, 
		f.txNome as txNomeBilling,f.txCognome as txCognomeBilling, 
		f.txVia as txViaBilling, f.txComune as txComuneBilling, 
		f.cdCap as cdCapBilling, f.txProvincia as txProvinciaBilling, 
		f.txNazione as txNazioneBilling, f.txTel as txTelBilling,
		f.txEtichetta as etichettaBilling,   f.fgDeleted,
		g.IDAddress as idAddressDelivery, 
		g.txNome as txNomeDelivery, g.txCognome as txCognomeDelivery, 
		g.txVia as txViaDelivery, g.txComune as txComuneDelivery, 
		g.cdCap as cdCapDelivery, g.txProvincia as txProvinciaDelivery, 
		g.txNazione as txNazioneDelivery, g.txTel as txTelDelivery,g.txEtichetta as etichettaDelivery, g.fgDeleted
 		FROM
		${database.schema}orders a,
		${database.schema}orders_articles b,
		${database.schema}states_orders c,
		${database.schema}states d,
		${database.schema}addresses f,
		${database.schema}addresses g
		WHERE a.idOrder = b.idOrder
		and a.idOrder = c.idOrder
		<if test="idOrder != null">
			and a.idOrder = #{idOrder}
		</if>
		<if test="idUser != null">
			and a.idUser = #{idUser}
		</if>
		and a.idAddressFat = f.idAddress
		and a.idAddressSpe = g.idAddress
		and c.idStato = d.idStato
		<if test="idStato != null">
			and c.idStato = #{idStato}
		</if>
		<if test="idStato == null">
			and c.idStato = (SELECT MAX(e.idStato) 
							 FROM ${database.schema}states_orders e
							 WHERE e.idOrder = a.idOrder)
		</if>

	</select>


	<insert id="insertOrder"   parameterType="it.othala.dto.OrderFullDTO">
      
		INSERT INTO
		${database.schema}orders
		(`idUser`,`imOrdine`,`imSpeseSpedizione`,`idTransaction`,`idAddressFatt`
		,`idAddressDelivery`)
		values (
		#{idUser},#{imOrdine},#{imSpeseSpedizione},null,
		#{billingAddress.idAddress}, #{billingAddress.idAddress})
		
        <selectKey resultType="java.lang.Integer" keyProperty="idOrder" >

            SELECT LAST_INSERT_ID() AS idOrder

        </selectKey>
    </insert>

	<update id="updateOrder"   parameterType="java.util.HashMap">
      
		UPDATE ${database.schema}orders
		SET idTransaction = #{idTransaction}
		WHERE idOrder = #{idOrder}
      
    </update>

	<insert id="insertOrdersArticles" parameterType="java.util.HashMap">

		INSERT INTO
		${database.schema}orders_articles
		(`idOrder`,`idProdotto`,`pgArticle`,`qtArticle`)
		values (#{idOrder},#{idProdotto},#{pgArticle},#{qtArticle})

	</insert>

	<insert id="insertStatesOrders" parameterType="it.othala.dto.OrderFullDTO">
		INSERT INTO
		${database.schema}states_orders
		(`idOrder`,`idStato`,`dtStato`,`txNote`)
		VALUES
		(#{idOrder},1,now(),#{txNote});

	</insert>
	
	<insert id="updateStatesOrders" parameterType="it.othala.dto.StateOrderDTO">
		INSERT INTO
		${database.schema}states_orders
		(`idOrder`,`idStato`,`dtStato`,`txNote`)
		VALUES
		(#{idOrder},#{idStato},now(),#{txNote});

	</insert>
	
	<select id="deliveryAddresses" resultType="it.othala.dto.DeliveryAddressDTO"
		parameterType="java.lang.String">
		
		SELECT
		a.idAddress, a.idUser as userId, a.txNome as nome,a.txCognome as cognome,
		a.txVia as via, a.txComune as comune, a.cdCap as cap, a.txEtichetta as etichetta,
		a.txProvincia as provincia, a.txNazione as nazione, 
		a.txTel as tel, c.idUser as userId
		FROM
		${database.schema}addresses a,
		${database.schema}customer c
		WHERE
		a.idUser = #{userId} and
		a.idUser = c.idUser
		a.fgDeleted = 0
	
	</select>
	
	<select id="deliveryCosts" resultType="it.othala.dto.DeliveryCostDTO">

		SELECT
		txDescrizione as descrizione,
		imSpese as importospese
		FROM 
		${database.schema}delivery_cost

	</select>
	
	<insert id="insertAddress" parameterType="it.othala.dto.DeliveryAddressDTO">
		INSERT INTO
		${database.schema}addresses
		('idUser','txNome','txCognome','txVia',
		'txComune', 'cdCap', 
		'txProvincia','txNazione','txTel','fgDeleted','txEtichetta')
		VALUES
		(#{userId},#{nome},#{cognome},#{via},
		#{comune},#{cap},#{provincia},#{nazione},#{tel},0,#{etichetta});
		
		<selectKey resultType="java.lang.Integer" keyProperty="idAddress" >

            SELECT LAST_INSERT_ID() AS idAddress

        </selectKey>

	</insert>
	

	<delete id="deleteAddress" parameterType="java.lang.Integer">
		
		UPDATE ${database.schema}addresses
		SET fgDeleted = 1 
		WHERE 
		idAddress = #{idAddress}
		

	</delete>
	
	<insert id="insertDeliveryCost" parameterType="it.othala.dto.DeliveryCostDTO">
		INSERT INTO
		${database.schema}delivery_cost
		(`txDescrizione`,`imSpese`)
		VALUES
		(#{descrizione},#{importospese});

	</insert>

</mapper>